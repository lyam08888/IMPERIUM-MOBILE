<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMPERIUM - Foedus (Alliances)</title>
    <meta name="description" content="G√©rez vos alliances et relations diplomatiques dans IMPERIUM.">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' fill='%23b45309'/><text x='16' y='20' text-anchor='middle' fill='white' font-family='serif' font-size='20' font-weight='bold'>I</text></svg>" type="image/svg+xml">

    <!-- Styles et scripts communs -->
    <link rel="stylesheet" href="../common-styles.css">
    <script src="../common-navigation.js"></script>
    <script src="../game-engine.js"></script>
    <script src="../advanced-game-systems.js"></script>
    <script src="../save-system.js"></script>
    <script src="../ui-manager.js"></script>
    <script src="../global-console.js"></script>

    <style>
        /* Styles sp√©cifiques aux alliances */
        .alliance-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .alliance-section {
            background: linear-gradient(135deg, 
                rgba(139, 0, 0, 0.1) 0%, 
                rgba(0, 0, 0, 0.3) 100%);
            border: 2px solid var(--roman-bronze, #CD7F32);
            border-radius: 1rem;
            padding: 2rem;
            backdrop-filter: blur(10px);
        }

        .section-title {
            color: var(--roman-gold, #FFD700);
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            text-align: center;
            font-family: 'Times New Roman', serif;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .section-title::before {
            content: '‚öúÔ∏è ';
        }

        .section-title::after {
            content: ' ‚öúÔ∏è';
        }

        /* Alliance actuelle */
        .current-alliance {
            background: rgba(34, 197, 94, 0.1);
            border-color: #22c55e;
        }

        .alliance-info {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0.8rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--roman-bronze, #CD7F32);
        }

        .alliance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .alliance-name {
            color: var(--roman-gold, #FFD700);
            font-size: 1.3rem;
            font-weight: bold;
            font-family: 'Times New Roman', serif;
        }

        .alliance-level {
            background: linear-gradient(135deg, var(--roman-gold, #FFD700), var(--roman-bronze, #CD7F32));
            color: var(--roman-red, #8B0000);
            padding: 0.3rem 0.8rem;
            border-radius: 1rem;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .alliance-description {
            color: var(--roman-marble, #F8F8FF);
            margin-bottom: 1rem;
            line-height: 1.5;
            font-style: italic;
        }

        .alliance-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .alliance-stat {
            text-align: center;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0.5rem;
            padding: 1rem;
        }

        .alliance-stat-value {
            color: var(--roman-gold, #FFD700);
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.3rem;
        }

        .alliance-stat-label {
            color: var(--roman-marble, #F8F8FF);
            font-size: 0.8rem;
        }

        .alliance-bonuses {
            background: rgba(34, 197, 94, 0.1);
            border-radius: 0.5rem;
            padding: 1rem;
            border: 1px solid #22c55e;
        }

        .bonus-title {
            color: #22c55e;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .bonus-list {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .bonus-item {
            color: var(--roman-marble, #F8F8FF);
            font-size: 0.9rem;
        }

        /* Membres de l'alliance */
        .members-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .member-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.8rem;
            border: 1px solid var(--roman-bronze, #CD7F32);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .member-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--roman-gold, #FFD700), var(--roman-bronze, #CD7F32));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--roman-red, #8B0000);
        }

        .member-details {
            flex: 1;
        }

        .member-name {
            color: var(--roman-gold, #FFD700);
            font-weight: bold;
            margin-bottom: 0.2rem;
        }

        .member-role {
            color: var(--roman-marble, #F8F8FF);
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .member-stats {
            text-align: right;
            font-size: 0.8rem;
        }

        .member-power {
            color: #22c55e;
            font-weight: bold;
        }

        .member-contribution {
            color: var(--roman-marble, #F8F8FF);
            opacity: 0.7;
        }

        /* Actions d'alliance */
        .alliance-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .alliance-btn {
            background: linear-gradient(135deg, var(--roman-red, #8B0000), var(--roman-bronze, #CD7F32));
            color: var(--roman-marble, #F8F8FF);
            border: 2px solid var(--roman-gold, #FFD700);
            border-radius: 0.8rem;
            padding: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Times New Roman', serif;
            text-align: center;
        }

        .alliance-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }

        .alliance-btn.primary {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

        .alliance-btn.danger {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }

        /* Cr√©ation d'alliance */
        .create-alliance {
            background: rgba(34, 197, 94, 0.1);
            border-color: #22c55e;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            color: var(--roman-marble, #F8F8FF);
            font-weight: bold;
            margin-bottom: 0.5rem;
            display: block;
        }

        .form-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--roman-bronze, #CD7F32);
            border-radius: 0.5rem;
            padding: 1rem;
            color: var(--roman-marble, #F8F8FF);
            font-size: 1rem;
        }

        .form-input:focus {
            border-color: var(--roman-gold, #FFD700);
            outline: none;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Invitations */
        .invitations-section {
            background: rgba(139, 0, 0, 0.1);
            border-color: var(--roman-red, #8B0000);
        }

        .invitation-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid var(--roman-bronze, #CD7F32);
        }

        .invitation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .invitation-alliance {
            color: var(--roman-gold, #FFD700);
            font-weight: bold;
        }

        .invitation-time {
            color: var(--roman-marble, #F8F8FF);
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .invitation-description {
            color: var(--roman-marble, #F8F8FF);
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .invitation-actions {
            display: flex;
            gap: 1rem;
        }

        .invitation-btn {
            flex: 1;
            padding: 0.8rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .invitation-btn.accept {
            background: #22c55e;
            color: white;
        }

        .invitation-btn.decline {
            background: #dc2626;
            color: white;
        }

        .invitation-btn:hover {
            transform: translateY(-1px);
        }

        /* Tr√©sorerie d'alliance */
        .treasury-section {
            grid-column: 1 / -1;
            background: rgba(255, 215, 0, 0.1);
            border-color: var(--roman-gold, #FFD700);
        }

        .treasury-resources {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .treasury-resource {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
            border: 1px solid var(--roman-bronze, #CD7F32);
        }

        .treasury-resource-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .treasury-resource-amount {
            color: var(--roman-gold, #FFD700);
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 0.3rem;
        }

        .treasury-resource-name {
            color: var(--roman-marble, #F8F8FF);
            font-size: 0.9rem;
        }

        .contribution-form {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0.8rem;
            padding: 1.5rem;
            border: 1px solid var(--roman-bronze, #CD7F32);
        }

        .contribution-title {
            color: var(--roman-gold, #FFD700);
            font-weight: bold;
            margin-bottom: 1rem;
            text-align: center;
        }

        .contribution-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .contribution-input-group {
            text-align: center;
        }

        .contribution-input {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--roman-bronze, #CD7F32);
            border-radius: 0.3rem;
            padding: 0.5rem;
            color: var(--roman-marble, #F8F8FF);
            text-align: center;
        }

        .contribution-available {
            color: var(--roman-marble, #F8F8FF);
            font-size: 0.8rem;
            margin-top: 0.3rem;
            opacity: 0.7;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .alliance-layout {
                grid-template-columns: 1fr;
            }
            
            .alliance-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .alliance-actions {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Particules d'arri√®re-plan -->
    <div class="particles"></div>

    <!-- INTERFACE PRINCIPALE DU JEU -->
    <div class="imperium-ui">
        <!-- HEADER -->
        <header class="imperium-header">
            <div class="header-content">
                <h1 class="imperium-logo">IMPERIUM</h1>
                <div id="resources-display" class="resources-display">
                    <!-- Les ressources seront inject√©es ici par JS -->
                </div>
                <div class="player-info">
                    <div class="player-avatar" id="player-avatar">üèõÔ∏è</div>
                    <div>
                        <div class="player-name" id="player-name"></div>
                        <div class="player-level" id="player-title-level"></div>
                    </div>
                </div>
            </div>
        </header>

        <!-- CORPS PRINCIPAL -->
        <div class="imperium-body">
            <!-- BARRE LATERALE (Desktop) -->
            <aside class="imperium-sidebar">
                <!-- Navigation g√©n√©r√©e dynamiquement par common-navigation.js -->
            </aside>

            <!-- CONTENU PRINCIPAL -->
            <main class="main-content">
                <div class="view-container">
                    <h2 class="view-title">ü§ù Foedus - Alliances Romaines</h2>
                    
                    <div class="alliance-layout" id="alliance-layout">
                        <!-- Contenu g√©n√©r√© dynamiquement -->
                    </div>
                    
                    <!-- Tr√©sorerie d'alliance (si membre) -->
                    <div class="alliance-section treasury-section" id="treasury-section" style="display: none;">
                        <h3 class="section-title">Aerarium Foederis (Tr√©sorerie)</h3>
                        
                        <div class="treasury-resources" id="treasury-resources">
                            <!-- G√©n√©r√© par JavaScript -->
                        </div>
                        
                        <div class="contribution-form">
                            <div class="contribution-title">üí∞ Contribuer √† la Tr√©sorerie</div>
                            <div class="contribution-inputs" id="contribution-inputs">
                                <!-- G√©n√©r√© par JavaScript -->
                            </div>
                            <button class="alliance-btn primary" onclick="contributeToTreasury()">
                                üèõÔ∏è Contribuer √† l'Alliance
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Variables globales
        let uiManager;
        let currentAlliance = null;
        let pendingInvitations = [];
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // Initialiser le moteur de jeu s'il n'est pas d√©j√† initialis√©
            if (!gameEngine.isRunning) {
                gameEngine.init();
            }
            
            // Initialiser le gestionnaire d'interface
            uiManager = new ImperiumUIManager(gameEngine);
            
            // Charger les donn√©es d'alliance
            loadAllianceData();
            
            // G√©n√©rer l'interface
            generateAllianceInterface();
            
            console.log('ü§ù Syst√®me d\'alliances initialis√©!');
        });
        
        // Chargement des donn√©es d'alliance
        function loadAllianceData() {
            const gameState = gameEngine.getGameState();
            
            // V√©rifier si le joueur a une alliance
            if (gameState.player.alliance) {
                currentAlliance = allianceSystem.getAllianceData(gameState.player.alliance.id);
            }
            
            // Charger les invitations en attente
            pendingInvitations = allianceSystem.invitations.filter(inv => 
                inv.playerId === 'player' && inv.status === 'pending'
            );
        }
        
        // G√©n√©ration de l'interface
        function generateAllianceInterface() {
            const container = document.getElementById('alliance-layout');
            
            if (currentAlliance) {
                // Joueur membre d'une alliance
                container.innerHTML = `
                    <div class="alliance-section current-alliance">
                        ${generateCurrentAllianceSection()}
                    </div>
                    <div class="alliance-section">
                        ${generateMembersSection()}
                    </div>
                `;
                
                // Afficher la tr√©sorerie
                document.getElementById('treasury-section').style.display = 'block';
                generateTreasurySection();
                
            } else {
                // Joueur sans alliance
                container.innerHTML = `
                    <div class="alliance-section create-alliance">
                        ${generateCreateAllianceSection()}
                    </div>
                    <div class="alliance-section invitations-section">
                        ${generateInvitationsSection()}
                    </div>
                `;
            }
        }
        
        function generateCurrentAllianceSection() {
            const bonuses = currentAlliance.bonuses;
            const experience = currentAlliance.experience;
            const nextLevelExp = currentAlliance.level * 1000;
            const expProgress = (experience / nextLevelExp) * 100;
            
            return `
                <h3 class="section-title">Mon Alliance</h3>
                
                <div class="alliance-info">
                    <div class="alliance-header">
                        <div class="alliance-name">üèõÔ∏è ${currentAlliance.name}</div>
                        <div class="alliance-level">Niveau ${currentAlliance.level}</div>
                    </div>
                    
                    <div class="alliance-description">
                        "${currentAlliance.description}"
                    </div>
                    
                    <div class="alliance-stats">
                        <div class="alliance-stat">
                            <div class="alliance-stat-value">${currentAlliance.members.length}</div>
                            <div class="alliance-stat-label">Membres</div>
                        </div>
                        <div class="alliance-stat">
                            <div class="alliance-stat-value">${currentAlliance.level}</div>
                            <div class="alliance-stat-label">Niveau</div>
                        </div>
                        <div class="alliance-stat">
                            <div class="alliance-stat-value">${Math.floor(expProgress)}%</div>
                            <div class="alliance-stat-label">Exp√©rience</div>
                        </div>
                        <div class="alliance-stat">
                            <div class="alliance-stat-value">${currentAlliance.wars.length}</div>
                            <div class="alliance-stat-label">Guerres</div>
                        </div>
                    </div>
                    
                    <div class="alliance-bonuses">
                        <div class="bonus-title">üéØ Bonus d'Alliance</div>
                        <div class="bonus-list">
                            <div class="bonus-item">üìà Production: +${Math.floor(bonuses.production * 100)}%</div>
                            <div class="bonus-item">üõ°Ô∏è D√©fense: +${Math.floor(bonuses.defense * 100)}%</div>
                            <div class="bonus-item">üî¨ Recherche: +${Math.floor(bonuses.research * 100)}%</div>
                        </div>
                    </div>
                </div>
                
                <div class="alliance-actions">
                    <button class="alliance-btn" onclick="invitePlayer()">
                        üë• Inviter un Joueur
                    </button>
                    <button class="alliance-btn" onclick="viewAllianceWars()">
                        ‚öîÔ∏è Guerres d'Alliance
                    </button>
                    <button class="alliance-btn" onclick="manageAlliance()">
                        ‚öôÔ∏è G√©rer l'Alliance
                    </button>
                    <button class="alliance-btn danger" onclick="leaveAlliance()">
                        üö™ Quitter l'Alliance
                    </button>
                </div>
            `;
        }
        
        function generateMembersSection() {
            const members = currentAlliance.members;
            
            return `
                <h3 class="section-title">Membres (${members.length}/50)</h3>
                
                <div class="members-list">
                    ${members.map(memberId => {
                        const isFounder = memberId === currentAlliance.founderId;
                        const isPlayer = memberId === 'player';
                        const memberName = isPlayer ? gameEngine.getGameState().player.name : `Citoyen ${memberId.slice(-4)}`;
                        const memberPower = Math.floor(Math.random() * 50000) + 10000;
                        const contribution = Math.floor(Math.random() * 10000) + 1000;
                        
                        return `
                            <div class="member-item">
                                <div class="member-info">
                                    <div class="member-avatar">
                                        ${isFounder ? 'üëë' : isPlayer ? 'üèõÔ∏è' : 'üè∫'}
                                    </div>
                                    <div class="member-details">
                                        <div class="member-name">
                                            ${memberName} ${isPlayer ? '(Vous)' : ''}
                                        </div>
                                        <div class="member-role">
                                            ${isFounder ? 'Imperator (Fondateur)' : 'Civis (Membre)'}
                                        </div>
                                    </div>
                                </div>
                                <div class="member-stats">
                                    <div class="member-power">${memberPower.toLocaleString()} ‚öîÔ∏è</div>
                                    <div class="member-contribution">${contribution} ü™ô contrib.</div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        function generateCreateAllianceSection() {
            return `
                <h3 class="section-title">Cr√©er une Alliance</h3>
                
                <div class="form-group">
                    <label class="form-label">Nom de l'Alliance</label>
                    <input type="text" class="form-input" id="alliance-name" placeholder="Ex: SPQR, Legio XIII, Aquila...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-input form-textarea" id="alliance-description" 
                              placeholder="D√©crivez les objectifs et la philosophie de votre alliance..."></textarea>
                </div>
                
                <div class="alliance-actions">
                    <button class="alliance-btn primary" onclick="createAlliance()">
                        üèõÔ∏è Fonder l'Alliance (1000 ü™ô)
                    </button>
                    <button class="alliance-btn" onclick="searchAlliances()">
                        üîç Chercher des Alliances
                    </button>
                </div>
                
                <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(255, 215, 0, 0.1); border-radius: 0.5rem; border: 1px solid var(--roman-gold);">
                    <div style="color: var(--roman-gold); font-weight: bold; margin-bottom: 0.5rem;">
                        üí° Avantages des Alliances
                    </div>
                    <div style="color: var(--roman-marble); font-size: 0.9rem; line-height: 1.4;">
                        ‚Ä¢ Bonus de production, d√©fense et recherche<br>
                        ‚Ä¢ Tr√©sorerie commune pour les projets<br>
                        ‚Ä¢ Guerres coordonn√©es et d√©fense mutuelle<br>
                        ‚Ä¢ Chat et coordination strat√©gique<br>
                        ‚Ä¢ √âv√©nements d'alliance exclusifs
                    </div>
                </div>
            `;
        }
        
        function generateInvitationsSection() {
            if (pendingInvitations.length === 0) {
                return `
                    <h3 class="section-title">Invitations</h3>
                    <div style="text-align: center; color: var(--roman-marble); padding: 2rem; opacity: 0.6;">
                        üìú Aucune invitation en attente<br>
                        <small>Les invitations d'alliance appara√Ætront ici</small>
                    </div>
                `;
            }
            
            return `
                <h3 class="section-title">Invitations (${pendingInvitations.length})</h3>
                
                ${pendingInvitations.map(invitation => {
                    const timeAgo = formatTimeAgo(Date.now() - invitation.timestamp);
                    
                    return `
                        <div class="invitation-item">
                            <div class="invitation-header">
                                <div class="invitation-alliance">üèõÔ∏è ${invitation.allianceName}</div>
                                <div class="invitation-time">${timeAgo}</div>
                            </div>
                            <div class="invitation-description">
                                Vous √™tes invit√© √† rejoindre cette alliance. 
                                Acceptez pour b√©n√©ficier des bonus et participer aux activit√©s communes.
                            </div>
                            <div class="invitation-actions">
                                <button class="invitation-btn accept" onclick="acceptInvitation('${invitation.id}')">
                                    ‚úÖ Accepter
                                </button>
                                <button class="invitation-btn decline" onclick="declineInvitation('${invitation.id}')">
                                    ‚ùå Refuser
                                </button>
                            </div>
                        </div>
                    `;
                }).join('')}
            `;
        }
        
        function generateTreasurySection() {
            const treasury = currentAlliance.treasury;
            const container = document.getElementById('treasury-resources');
            
            container.innerHTML = Object.keys(RESOURCES_CONFIG).map(resource => {
                if (resource === 'research') return ''; // Exclure la recherche
                
                const config = RESOURCES_CONFIG[resource];
                const amount = treasury[resource] || 0;
                
                return `
                    <div class="treasury-resource">
                        <div class="treasury-resource-icon">${config.icon}</div>
                        <div class="treasury-resource-amount">${amount.toLocaleString()}</div>
                        <div class="treasury-resource-name">${config.name}</div>
                    </div>
                `;
            }).join('');
            
            // G√©n√©rer les inputs de contribution
            const contributionContainer = document.getElementById('contribution-inputs');
            const gameState = gameEngine.getGameState();
            
            contributionContainer.innerHTML = Object.keys(RESOURCES_CONFIG).map(resource => {
                if (resource === 'research') return '';
                
                const config = RESOURCES_CONFIG[resource];
                const available = gameState.resources[resource] || 0;
                
                return `
                    <div class="contribution-input-group">
                        <div style="color: var(--roman-gold); font-weight: bold; margin-bottom: 0.5rem;">
                            ${config.icon} ${config.name.split(' ')[0]}
                        </div>
                        <input type="number" class="contribution-input" id="contribute-${resource}" 
                               placeholder="0" min="0" max="${available}">
                        <div class="contribution-available">Max: ${available}</div>
                    </div>
                `;
            }).join('');
        }
        
        // Actions d'alliance
        function createAlliance() {
            const name = document.getElementById('alliance-name').value.trim();
            const description = document.getElementById('alliance-description').value.trim();
            
            if (!name) {
                uiManager.showNotification('Erreur', 'Veuillez saisir un nom d\'alliance', 'error');
                return;
            }
            
            const gameState = gameEngine.getGameState();
            if (gameState.resources.gold < 1000) {
                uiManager.showNotification('Erreur', 'Or insuffisant (1000 ü™ô requis)', 'error');
                return;
            }
            
            try {
                const alliance = allianceSystem.createAlliance(name, description);
                gameState.resources.gold -= 1000;
                
                uiManager.showNotification('Alliance Cr√©√©e', `L'alliance "${name}" a √©t√© fond√©e avec succ√®s!`, 'success');
                
                // Recharger l'interface
                loadAllianceData();
                generateAllianceInterface();
                
            } catch (error) {
                uiManager.showNotification('Erreur', error.message, 'error');
            }
        }
        
        function acceptInvitation(invitationId) {
            try {
                const alliance = allianceSystem.acceptInvitation(invitationId);
                uiManager.showNotification('Alliance Rejointe', `Bienvenue dans l'alliance "${alliance.name}"!`, 'success');
                
                // Recharger l'interface
                loadAllianceData();
                generateAllianceInterface();
                
            } catch (error) {
                uiManager.showNotification('Erreur', error.message, 'error');
            }
        }
        
        function declineInvitation(invitationId) {
            const invitation = pendingInvitations.find(inv => inv.id == invitationId);
            if (invitation) {
                invitation.status = 'declined';
                uiManager.showNotification('Invitation Refus√©e', `Invitation de "${invitation.allianceName}" refus√©e`, 'info');
                
                // Recharger l'interface
                loadAllianceData();
                generateAllianceInterface();
            }
        }
        
        function leaveAlliance() {
            if (!currentAlliance) return;
            
            uiManager.showModal('Quitter l\'Alliance', `
                <div style="text-align: center; padding: 1rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                    <div style="color: var(--roman-marble); margin-bottom: 1.5rem;">
                        √ätes-vous s√ªr de vouloir quitter l'alliance "${currentAlliance.name}" ?<br>
                        <strong>Cette action est irr√©versible.</strong>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <button class="alliance-btn danger" onclick="confirmLeaveAlliance()">
                            üö™ Confirmer
                        </button>
                        <button class="alliance-btn" onclick="uiManager.closeModal()">
                            ‚ùå Annuler
                        </button>
                    </div>
                </div>
            `);
        }
        
        function confirmLeaveAlliance() {
            try {
                allianceSystem.leaveAlliance(currentAlliance.id);
                uiManager.closeModal();
                uiManager.showNotification('Alliance Quitt√©e', 'Vous avez quitt√© l\'alliance', 'info');
                
                // Recharger l'interface
                currentAlliance = null;
                loadAllianceData();
                generateAllianceInterface();
                
            } catch (error) {
                uiManager.showNotification('Erreur', error.message, 'error');
            }
        }
        
        function contributeToTreasury() {
            const contributions = {};
            let hasContribution = false;
            
            Object.keys(RESOURCES_CONFIG).forEach(resource => {
                if (resource === 'research') return;
                
                const input = document.getElementById(`contribute-${resource}`);
                const amount = parseInt(input.value) || 0;
                
                if (amount > 0) {
                    contributions[resource] = amount;
                    hasContribution = true;
                }
            });
            
            if (!hasContribution) {
                uiManager.showNotification('Erreur', 'Veuillez saisir au moins une contribution', 'error');
                return;
            }
            
            try {
                allianceSystem.contributeToTreasury(currentAlliance.id, contributions);
                
                const contributionText = Object.keys(contributions).map(resource => 
                    `${contributions[resource]} ${RESOURCES_CONFIG[resource].icon}`
                ).join(', ');
                
                uiManager.showNotification('Contribution Effectu√©e', 
                    `Contribution √† la tr√©sorerie: ${contributionText}`, 'success');
                
                // R√©initialiser les inputs
                Object.keys(contributions).forEach(resource => {
                    document.getElementById(`contribute-${resource}`).value = '';
                });
                
                // Recharger l'interface
                loadAllianceData();
                generateTreasurySection();
                
            } catch (error) {
                uiManager.showNotification('Erreur', error.message, 'error');
            }
        }
        
        function invitePlayer() {
            uiManager.showModal('Inviter un Joueur', `
                <div style="padding: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Nom du joueur</label>
                        <input type="text" class="form-input" id="invite-player-name" 
                               placeholder="Nom du joueur √† inviter">
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem;">
                        <button class="alliance-btn primary" onclick="sendInvitation()">
                            üì® Envoyer l'Invitation
                        </button>
                        <button class="alliance-btn" onclick="uiManager.closeModal()">
                            ‚ùå Annuler
                        </button>
                    </div>
                </div>
            `);
        }
        
        function sendInvitation() {
            const playerName = document.getElementById('invite-player-name').value.trim();
            
            if (!playerName) {
                uiManager.showNotification('Erreur', 'Veuillez saisir un nom de joueur', 'error');
                return;
            }
            
            // Simuler l'envoi d'invitation
            uiManager.closeModal();
            uiManager.showNotification('Invitation Envoy√©e', 
                `Invitation envoy√©e √† ${playerName}`, 'success');
        }
        
        function searchAlliances() {
            // Simuler la recherche d'alliances
            uiManager.showNotification('Recherche', 'Fonctionnalit√© en d√©veloppement...', 'info');
        }
        
        function viewAllianceWars() {
            uiManager.showNotification('Guerres d\'Alliance', 'Fonctionnalit√© en d√©veloppement...', 'info');
        }
        
        function manageAlliance() {
            uiManager.showNotification('Gestion', 'Fonctionnalit√© en d√©veloppement...', 'info');
        }
        
        // Utilitaires
        function formatTimeAgo(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) {
                return `il y a ${days}j`;
            } else if (hours > 0) {
                return `il y a ${hours}h`;
            } else if (minutes > 0) {
                return `il y a ${minutes}min`;
            } else {
                return `il y a ${seconds}s`;
            }
        }
        
        // Ajouter quelques invitations de d√©monstration
        setTimeout(() => {
            if (pendingInvitations.length === 0 && !currentAlliance) {
                // Simuler quelques invitations
                allianceSystem.invitations.push({
                    id: Date.now(),
                    allianceId: 'demo1',
                    allianceName: 'SPQR',
                    playerId: 'player',
                    inviterId: 'caesar',
                    timestamp: Date.now() - 300000, // Il y a 5 minutes
                    status: 'pending'
                });
                
                allianceSystem.invitations.push({
                    id: Date.now() + 1,
                    allianceId: 'demo2',
                    allianceName: 'Legio XIII',
                    playerId: 'player',
                    inviterId: 'marcus',
                    timestamp: Date.now() - 600000, // Il y a 10 minutes
                    status: 'pending'
                });
                
                loadAllianceData();
                generateAllianceInterface();
            }
        }, 2000);
    </script>
</body>
</html>
