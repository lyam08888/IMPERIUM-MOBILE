<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMPERIUM - Forge ton Empire Romain</title>
    <meta name="description" content="Incarnez un patricien romain et b√¢tissez votre empire. G√©rez vos provinces, vos l√©gions et dominez la M√©diterran√©e.">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' fill='%23b45309'/><text x='16' y='20' text-anchor='middle' fill='white' font-family='serif' font-size='20' font-weight='bold'>I</text></svg>" type="image/svg+xml">

    <!-- D√©pendances Leaflet.js pour la carte interactive -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        :root {
            --gold-primary: #d97706;
            --gold-secondary: #f59e0b;
            --gold-light: #fbbf24;
            --marble-white: #f8fafc;
            --roman-red: #dc2626;
            --roman-purple: #7c3aed;
            --dark-stone: #1e293b;
            --dark-marble: #334155;
            --dark-bg: #0f172a;
            --text-light: #e2e8f0;
            --text-muted: #94a3b8;
            --border-gold: rgba(217, 119, 6, 0.3);
            --shadow-gold: rgba(217, 119, 6, 0.4);
            --success-green: #22c55e;
            --storage-full-red: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            font-family: 'Times New Roman', serif;
            background: 
                radial-gradient(circle at 20% 20%, rgba(217, 119, 6, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(124, 58, 237, 0.1) 0%, transparent 50%),
                linear-gradient(135deg, var(--dark-bg) 0%, var(--dark-stone) 100%);
            color: var(--text-light);
            overflow: hidden;
            min-height: 100vh;
        }

        .particles {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1;
        }

        .particle {
            position: absolute;
            width: 3px; height: 3px;
            background: var(--gold-light);
            border-radius: 50%;
            animation: float 8s infinite linear;
            opacity: 0.6;
        }

        @keyframes float {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
        }

        /* Layout principal */
        .imperium-ui {
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: relative;
            z-index: 10;
        }

        .imperium-header {
            background: linear-gradient(135deg, var(--dark-marble) 0%, var(--dark-stone) 100%);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid var(--border-gold);
            padding: 1rem 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 100;
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .imperium-logo {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, var(--gold-primary), var(--gold-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            letter-spacing: 2px;
        }

        .resources-display {
            display: flex;
            gap: 1.5rem;
            background: rgba(15, 23, 42, 0.7);
            padding: 0.75rem 1.5rem;
            border-radius: 1rem;
            border: 1px solid var(--border-gold);
        }

        .resource-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: bold;
            font-size: 1rem;
            position: relative;
        }
        
        .resource-item .storage-full-indicator {
            color: var(--storage-full-red);
            font-weight: bold;
        }

        .resource-icon {
            font-size: 1.2rem;
            filter: drop-shadow(0 0 5px var(--shadow-gold));
        }

        .resource-value {
            color: var(--gold-light);
            min-width: 50px;
            text-align: right;
            transition: color 0.3s ease;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .player-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--roman-red), var(--roman-purple));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            border: 2px solid var(--gold-primary);
        }

        .player-details {
            font-size: 0.9rem;
        }

        .player-name {
            color: var(--gold-light);
            font-weight: bold;
        }

        .player-level {
            color: var(--text-muted);
        }

        /* Corps principal */
        .imperium-body {
            display: flex;
            flex-grow: 1;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
            gap: 1.5rem;
            padding: 1.5rem 2rem;
            overflow: hidden;
        }

        /* Navigation lat√©rale */
        .imperium-sidebar {
            width: 280px;
            flex-shrink: 0;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(30, 41, 59, 0.8) 100%);
            border-radius: 1rem;
            border: 1px solid var(--border-gold);
            padding: 1.5rem;
            overflow-y: auto;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-title {
            color: var(--gold-primary);
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--border-gold);
            padding-bottom: 0.5rem;
        }

        .nav-list {
            list-style: none;
        }

        .nav-item a {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: var(--text-light);
            text-decoration: none;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            cursor: pointer;
        }

        .nav-item a:hover, .nav-item a.active {
            background: linear-gradient(135deg, rgba(217, 119, 6, 0.2), rgba(245, 158, 11, 0.1));
            border-color: var(--gold-primary);
            transform: translateX(5px);
            color: var(--gold-light);
        }

        .nav-icon {
            font-size: 1.3rem;
            width: 24px;
            text-align: center;
        }

        /* Vue principale */
        .main-content {
            flex-grow: 1;
            position: relative;
            overflow: hidden;
        }

        .view-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(30, 41, 59, 0.8) 100%);
            border-radius: 1rem;
            border: 1px solid var(--border-gold);
            overflow-y: auto;
            padding: 2rem;
            opacity: 0;
            visibility: hidden;
            transform: translateX(50px);
            transition: all 0.5s ease;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .view-container.active {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }

        .view-title {
            font-size: 2.2rem;
            font-weight: bold;
            color: var(--gold-primary);
            margin-bottom: 2rem;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        /* Vue Cit√© */
        .city-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            height: calc(100% - 80px); /* Ajust√© pour le titre */
        }

        .city-map {
            background: 
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><pattern id="marble" patternUnits="userSpaceOnUse" width="20" height="20"><rect width="20" height="20" fill="%23f1f5f9"/><path d="M0,10 Q5,5 10,10 T20,10" stroke="%23cbd5e1" stroke-width="0.5" fill="none"/></pattern><rect width="100" height="100" fill="url(%23marble)" opacity="0.1"/></svg>'),
                linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 1rem;
            position: relative;
            overflow: hidden;
            border: 2px solid var(--gold-primary);
            padding: 2rem;
        }

        .buildings-grid {
            display: grid;
            height: 100%;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 1rem;
        }

        .building-plot {
            background: rgba(217, 119, 6, 0.1);
            border: 2px dashed var(--gold-primary);
            border-radius: 0.75rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .building-plot::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="roman-pattern" patternUnits="userSpaceOnUse" width="10" height="10"><rect width="10" height="10" fill="none"/><path d="M0,0 L5,5 L10,0" stroke="%23d97706" stroke-width="0.5" opacity="0.2"/></pattern></defs><rect width="100" height="100" fill="url(%23roman-pattern)"/></svg>');
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .building-plot:hover::before {
            opacity: 1;
        }

        .building-plot:hover {
            background: rgba(217, 119, 6, 0.2);
            border-color: var(--gold-light);
            transform: scale(1.05) translateY(-5px);
            box-shadow: 0 10px 30px var(--shadow-gold);
        }

        .building-plot.built {
            background: linear-gradient(135deg, rgba(217, 119, 6, 0.3), rgba(245, 158, 11, 0.2));
            border: 2px solid var(--gold-primary);
        }

        .building-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            filter: drop-shadow(0 0 10px var(--shadow-gold));
        }

        .building-name {
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--gold-primary);
            text-align: center;
        }

        .building-level {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--gold-primary);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .city-panel {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 1rem;
            border: 1px solid var(--border-gold);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow-y: auto;
        }

        .panel-section {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 0.5rem;
            padding: 1rem;
            border: 1px solid var(--border-gold);
        }

        .section-title {
            color: var(--gold-primary);
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* --- NOUVEAUX STYLES POUR LA CARTE DU MONDE --- */
        #view-world {
            padding: 0; /* Pas de padding pour que la carte prenne toute la place */
        }

        .world-layout {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 0;
            height: 100%;
            width: 100%;
        }

        #world-map-container {
            position: relative;
            width: 100%;
            height: 100%;
            background-color: var(--dark-bg);
            border-radius: 1rem 0 0 1rem;
        }

        #world-map {
            width: 100%;
            height: 100%;
            border-radius: 1rem 0 0 1rem;
        }
        
        /* Style pour les tuiles de la carte (sombre) */
        .leaflet-tile-pane {
            filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7);
        }

        #world-info-panel {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9) 0%, rgba(30, 41, 59, 0.8) 100%);
            padding: 2rem;
            overflow-y: auto;
            border-left: 2px solid var(--border-gold);
        }
        
        .info-panel-title {
            color: var(--gold-primary);
            font-size: 1.8rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        
        .info-panel-section {
            margin-bottom: 1.5rem;
        }

        .info-panel-section h4 {
            color: var(--gold-light);
            border-bottom: 1px solid var(--border-gold);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }

        .info-panel-section p {
            color: var(--text-muted);
            line-height: 1.6;
        }
        
        .info-panel-section strong {
            color: var(--text-light);
            font-weight: bold;
        }

        .leaflet-popup-content-wrapper {
            background: var(--dark-marble);
            color: var(--text-light);
            border: 1px solid var(--border-gold);
            border-radius: 0.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
        }

        .leaflet-popup-content {
            margin: 1rem;
            font-family: 'Times New Roman', serif;
        }

        .leaflet-popup-tip {
            background: var(--dark-marble);
        }

        .leaflet-popup-close-button {
            color: var(--text-light) !important;
        }
        
        .map-marker-icon {
            font-size: 24px;
            text-shadow: 0 0 8px rgba(0,0,0,0.8);
            line-height: 1;
        }
        /* --- FIN DES NOUVEAUX STYLES --- */


        /* Vue Recherche */
        .research-layout {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
        }

        .research-branch {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 1rem;
            border: 1px solid var(--border-gold);
            padding: 1.5rem;
            overflow-y: auto;
        }

        .branch-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--gold-primary);
            margin-bottom: 1.5rem;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .tech-card {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid var(--border-gold);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .tech-card:hover {
            border-color: var(--gold-light);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .tech-card.researched {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(34, 197, 94, 0.2));
            border-color: var(--success-green);
        }

        .tech-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--gold-light);
            margin-bottom: 0.5rem;
        }

        .tech-description {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .tech-cost {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
        }

        .cost-display {
            color: var(--gold-light);
        }

        /* Vue Militaire */
        .military-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            height: calc(100% - 80px); /* Ajust√© */
        }

        .military-section {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 1rem;
            border: 1px solid var(--border-gold);
            padding: 1.5rem;
            overflow-y: auto;
        }

        .unit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .unit-card {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid var(--border-gold);
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .unit-card:hover {
            border-color: var(--gold-light);
            transform: translateY(-3px);
        }

        .unit-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .unit-name {
            font-weight: bold;
            color: var(--gold-light);
            font-size: 1rem;
        }
        
        .unit-count {
            font-size: 1.2rem;
            color: var(--text-light);
        }
        
        .unit-stats {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        /* Boutons d'action */
        .action-btn {
            background: linear-gradient(135deg, var(--gold-primary), var(--gold-secondary));
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            width: 100%;
            margin-top: 0.5rem;
        }

        .action-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px var(--shadow-gold);
        }

        .action-btn:disabled {
            background: #6b7280;
            cursor: not-allowed;
            transform: none;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: linear-gradient(135deg, var(--dark-marble), var(--dark-stone));
            border: 2px solid var(--gold-primary);
            border-radius: 1rem;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--gold-primary);
            margin-bottom: 1rem;
            font-weight: bold;
            text-align: center;
        }
        
        #modal-body {
            text-align: left;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .modal-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.confirm {
            background: var(--gold-primary);
            color: white;
        }

        .modal-btn.cancel {
            background: #6b7280;
            color: white;
        }
        
        .recruit-slider {
            width: 100%;
            margin: 1rem 0;
        }
        
        .recruit-details {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
        }

        /* Footer */
        .imperium-footer {
            background: linear-gradient(135deg, var(--dark-marble) 0%, var(--dark-stone) 100%);
            border-top: 2px solid var(--border-gold);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            z-index: 100;
        }

        .event-log {
            color: var(--text-muted);
            font-style: italic;
            font-size: 0.9rem;
        }

        .game-actions {
            display: flex;
            gap: 1rem;
        }

        .footer-btn {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid var(--border-gold);
            color: var(--text-light);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .footer-btn:hover {
            background: var(--gold-primary);
            color: white;
        }

        /* Navigation mobile */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: linear-gradient(135deg, var(--dark-marble) 0%, var(--dark-stone) 100%);
            backdrop-filter: blur(10px);
            border-top: 2px solid var(--border-gold);
            padding: 0.5rem 0;
            z-index: 200;
            justify-content: space-around;
        }

        .mobile-nav-item {
            flex-grow: 1;
            text-align: center;
            color: var(--text-muted);
            text-decoration: none;
            padding: 0.5rem;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .mobile-nav-item.active,
        .mobile-nav-item:hover {
            color: var(--gold-light);
            transform: translateY(-2px);
        }

        /* Stats rapides */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .stat-card {
            background: rgba(30, 41, 59, 0.6);
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-gold);
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--gold-light);
            transition: color 0.3s ease;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Animations pour les notifications */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000; /* Au-dessus de la modale */
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .notification {
            background: linear-gradient(135deg, var(--gold-primary), var(--gold-secondary));
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            animation: slideInRight 0.5s ease, fadeOut 0.5s ease 2.5s forwards;
        }
        
        .notification.success {
             background: linear-gradient(135deg, var(--success-green), #16a34a);
        }
        
        .notification.error {
             background: linear-gradient(135deg, var(--roman-red), #ef4444);
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; transform: translateY(-20px); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .resources-display {
                display: none;
            }
        }
        
        @media (max-width: 1024px) {
            .imperium-body {
                padding: 1rem;
            }
            
            .imperium-sidebar {
                display: none;
            }
            
            .imperium-ui {
                padding-bottom: 70px;
            }
            
            .mobile-nav {
                display: flex;
            }
            
            .city-layout, .military-layout, .research-layout, .world-layout {
                grid-template-columns: 1fr;
                grid-template-rows: auto;
                height: auto;
            }
             .city-map {
                height: 50vh;
             }
             #world-map-container {
                height: 50vh;
                border-radius: 1rem 1rem 0 0;
             }
             #world-map {
                border-radius: 1rem 1rem 0 0;
             }
             #world-info-panel {
                border-left: none;
                border-top: 2px solid var(--border-gold);
             }
        }

        @media (max-width: 640px) {
            .imperium-header {
                padding: 0.75rem 1rem;
            }
            
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .imperium-logo {
                font-size: 2rem;
            }
            
            .player-info {
                display: none;
            }
            
            .buildings-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.5rem;
            }
            
            .building-icon {
                font-size: 2rem;
            }
             .view-container {
                padding: 1rem;
             }
             .view-title {
                margin-bottom: 1rem;
                font-size: 1.8rem;
             }
        }

        /* Effets sp√©ciaux */
        .resource-gain {
            animation: resourcePulse 0.5s ease-in-out;
        }

        @keyframes resourcePulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); color: var(--success-green); }
        }

        .building-completed {
            animation: buildingComplete 0.8s ease-out;
        }

        @keyframes buildingComplete {
            0% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .progress-bar {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 0.5rem;
            height: 8px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            background: linear-gradient(90deg, var(--gold-primary), var(--gold-light));
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 0.5rem;
        }

        .hidden {
            display: none !important;
        }

        .grid-layout {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
    </style>
</head>
<body>
    <div id="particles"></div>
    <div id="notification-container"></div>

    <div class="imperium-ui">
        <!-- HEADER -->
        <header class="imperium-header">
            <div class="header-content">
                <h1 class="imperium-logo">IMPERIUM</h1>
                <div id="resources-display" class="resources-display">
                    <!-- Les ressources seront inject√©es ici par JS -->
                </div>
                <div class="player-info">
                    <div class="player-avatar" id="player-avatar">M</div>
                    <div>
                        <div class="player-name" id="player-name"></div>
                        <div class="player-level" id="player-title-level"></div>
                    </div>
                </div>
            </div>
        </header>

        <!-- CORPS PRINCIPAL -->
        <div class="imperium-body">
            <!-- BARRE LATERALE (Desktop) -->
            <aside class="imperium-sidebar">
                <div class="nav-section">
                    <h2 class="nav-title">Empire</h2>
                    <ul class="nav-list">
                        <li class="nav-item"><a data-view="city"><span class="nav-icon">üèõÔ∏è</span> Ma Cit√©</a></li>
                        <li class="nav-item"><a data-view="world"><span class="nav-icon">üåç</span> Monde</a></li>
                        <li class="nav-item"><a data-view="island"><span class="nav-icon">üèùÔ∏è</span> Province</a></li>
                    </ul>
                </div>
                <div class="nav-section">
                    <h2 class="nav-title">D√©veloppement</h2>
                    <ul class="nav-list">
                        <li class="nav-item"><a data-view="research"><span class="nav-icon">üìö</span> Acad√©mie</a></li>
                        <li class="nav-item"><a data-view="trade"><span class="nav-icon">‚öñÔ∏è</span> Commerce</a></li>
                    </ul>
                </div>
                <div class="nav-section">
                    <h2 class="nav-title">Militaire</h2>
                    <ul class="nav-list">
                        <li class="nav-item"><a data-view="military"><span class="nav-icon">‚öîÔ∏è</span> L√©gions</a></li>
                        <li class="nav-item"><a data-view="navy"><span class="nav-icon">üö¢</span> Flotte</a></li>
                        <li class="nav-item"><a data-view="battle"><span class="nav-icon">üí•</span> Simulateur</a></li>
                    </ul>
                </div>
                 <div class="nav-section">
                    <h2 class="nav-title">Social</h2>
                    <ul class="nav-list">
                        <li class="nav-item"><a data-view="diplomacy"><span class="nav-icon">ü§ù</span> Diplomatie</a></li>
                        <li class="nav-item"><a data-view="alliance"><span class="nav-icon">üõ°Ô∏è</span> Alliance</a></li>
                        <li class="nav-item"><a data-view="messages"><span class="nav-icon">‚úâÔ∏è</span> Messages</a></li>
                    </ul>
                </div>
            </aside>

            <!-- CONTENU PRINCIPAL -->
            <main class="main-content">
                <!-- Vue Cit√© -->
                <div id="view-city" class="view-container">
                    <h2 class="view-title">Ma Cit√©</h2>
                    <div class="city-layout">
                        <div class="city-map">
                            <div id="buildings-grid" class="buildings-grid"></div>
                        </div>
                        <div class="city-panel">
                            <div class="panel-section" id="city-stats-panel">
                                <h3 class="section-title">Statistiques de la Cit√©</h3>
                                <div id="city-stats-content"></div>
                            </div>
                            <div class="panel-section" id="storage-panel">
                                <h3 class="section-title">Entrep√¥t</h3>
                                <div id="storage-content"></div>
                            </div>
                             <div class="panel-section" id="production-panel">
                                <h3 class="section-title">Production / heure</h3>
                                <div id="production-content"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Vue Militaire -->
                <div id="view-military" class="view-container">
                    <h2 class="view-title">L√©gions Romaines</h2>
                    <div id="military-content-wrapper">
                        <div class="military-layout">
                            <div id="military-owned" class="military-section">
                                <h3 class="section-title">Mes Troupes</h3>
                                <div id="owned-units-grid" class="unit-grid"></div>
                            </div>
                            <div id="military-recruit" class="military-section">
                                <h3 class="section-title">Recruter des Unit√©s</h3>
                                <div id="recruit-units-grid" class="unit-grid"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Vue Monde -->
                <div id="view-world" class="view-container">
                    <!-- Le contenu sera g√©n√©r√© par renderWorldView() -->
                </div>
                <!-- Autres vues -->
                <div id="view-island" class="view-container"><h2 class="view-title">Province</h2><p>Cette fonctionnalit√© n'est pas encore impl√©ment√©e.</p></div>
                <div id="view-research" class="view-container"><h2 class="view-title">Acad√©mie de Recherche</h2><div id="research-layout" class="research-layout"></div></div>
                <div id="view-navy" class="view-container"><h2 class="view-title">Flotte Navale</h2><p>Cette fonctionnalit√© n'est pas encore impl√©ment√©e.</p></div>
                <div id="view-battle" class="view-container"><h2 class="view-title">Simulateur de Bataille</h2><p>Cette fonctionnalit√© n'est pas encore impl√©ment√©e.</p></div>
                <div id="view-trade" class="view-container"><h2 class="view-title">Commerce</h2><p>Cette fonctionnalit√© n'est pas encore impl√©ment√©e.</p></div>
                <div id="view-diplomacy" class="view-container"><h2 class="view-title">Diplomatie</h2><p>Cette fonctionnalit√© n'est pas encore impl√©ment√©e.</p></div>
                <div id="view-alliance" class="view-container"><h2 class="view-title">Alliance</h2><p>Cette fonctionnalit√© n'est pas encore impl√©ment√©e.</p></div>
                <div id="view-messages" class="view-container"><h2 class="view-title">Messagerie</h2><p>Cette fonctionnalit√© n'est pas encore impl√©ment√©e.</p></div>
            </main>
        </div>

        <!-- FOOTER -->
        <footer class="imperium-footer">
            <div id="event-log" class="event-log">Initialisation du jeu...</div>
            <div class="game-actions">
                <button id="save-btn" class="footer-btn">Sauvegarder</button>
                <button id="load-btn" class="footer-btn">Charger</button>
            </div>
        </footer>
    </div>

    <!-- NAVIGATION MOBILE -->
    <nav class="mobile-nav">
        <a class="mobile-nav-item" data-view="city">üèõÔ∏è</a>
        <a class="mobile-nav-item" data-view="world">üåç</a>
        <a class="mobile-nav-item" data-view="research">üìö</a>
        <a class="mobile-nav-item" data-view="military">‚öîÔ∏è</a>
        <a class="mobile-nav-item" data-view="alliance">üõ°Ô∏è</a>
    </nav>

    <!-- MODAL -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title" class="modal-title">Titre de la modale</h3>
            <div id="modal-body">Contenu de la modale...</div>
            <div id="modal-actions" class="modal-actions">
                 <button id="modal-cancel-btn" class="modal-btn cancel">Fermer</button>
            </div>
        </div>
    </div>
    
    <script>
        // Configuration globale du jeu
        const GAME_CONFIG = {
            version: '3.1.0',
            updateInterval: 5000, // Mise √† jour des ressources toutes les 5 secondes
        };

        // √âtat du jeu complet
        let gameState = {
            resources: { wood: 2450, stone: 1820, wine: 650, iron: 340, gold: 8750, research: 180 },
            buildings: {
                forum: { level: 5, x: 2, y: 1 },
                warehouse: { level: 3, x: 0, y: 0 },
                barracks: { level: 4, x: 4, y: 1 },
                academy: { level: 2, x: 1, y: 3 },
                lumbercamp: { level: 3, x: 0, y: 2 },
                quarry: { level: 2, x: 3, y: 0 },
                vineyard: { level: 1, x: 4, y: 3 }
            },
            technologies: ['aqueducs', 'phalanges', 'routes'],
            units: { velites: 45, hastati: 32, legionnaires: 18, equites: 12, balistes: 3 },
            navy: { triremes: 8, quinqueremes: 2, marchands: 15 },
            provinces: [ { name: 'Roma Nova', type: 'capital', population: 120, happiness: 75, islandBonus: {} } ],
            currentView: 'city',
            player: {
                name: 'Marcus Aurelius',
                level: 12,
                xp: 8750,
                title: 'Patricien',
                alliance: { name: 'SPQR Alliance', bonus: 0.1 }, // Bonus de 10%
                rank: 145
            },
            lastUpdate: Date.now(),
        };

        // Configuration des b√¢timents
        const BUILDINGS_CONFIG = {
            forum: { name: 'Forum', icon: 'üèõÔ∏è', description: 'Augmente la population maximale.' },
            warehouse: { name: 'Entrep√¥t', icon: 'üì¶', description: 'Augmente le stockage des ressources.' },
            barracks: { name: 'Caserne', icon: '‚öîÔ∏è', description: 'Recrutement des l√©gions.' },
            academy: { name: 'Acad√©mie', icon: 'üìö', description: 'Recherche et enseignement.' },
            lumbercamp: { name: 'Camp de B√ªcherons', icon: 'üå≤', description: 'Production de bois.', production: { type: 'wood', base: 10 } },
            quarry: { name: 'Carri√®re', icon: 'ü™®', description: 'Extraction de pierre.', production: { type: 'stone', base: 8 } },
            vineyard: { name: 'Vignoble', icon: 'üçá', description: 'Culture de la vigne.', production: { type: 'wine', base: 4 } },
            ironmine: { name: 'Mine de Fer', icon: '‚õèÔ∏è', description: 'Extraction de fer.', production: { type: 'iron', base: 6 } },
            mint: { name: 'Monnaie', icon: 'üí∞', description: 'Frappe de monnaies.', production: { type: 'gold', base: 5 } },
            tavern: { name: 'Taverne', icon: 'üç∫', description: 'Augmente le bonheur des citoyens.', happiness: 5 }, // +5 bonheur par niveau
            temple: { name: 'Temple', icon: '‚õ©Ô∏è', description: 'Culte des dieux romains.' },
            library: { name: 'Biblioth√®que', icon: 'üìñ', description: 'Conservation du savoir.' },
            shipyard: { name: 'Chantier Naval', icon: 'üö¢', description: 'Construction de navires.' },
            wall: { name: 'Muraille', icon: 'üõ°Ô∏è', description: 'D√©fense de la cit√©.' },
            amphitheater: { name: 'Amphith√©√¢tre', icon: 'üèüÔ∏è', description: 'Jeux et spectacles.' }
        };

        // Configuration des technologies
        const TECH_TREE = {
            urbanisme: { name: 'Urbanisme', icon: 'üèõÔ∏è', techs: [ { id: 'aqueducs', name: 'Aqueducs', cost: { research: 250 }, description: 'Am√©liore la qualit√© de vie (+15% bonheur)' }, { id: 'forum_avance', name: 'Forums Avanc√©s', cost: { research: 400 }, description: 'Augmente la capacit√© administrative' } ] },
            militaire: { name: 'Art Militaire', icon: '‚öîÔ∏è', techs: [ { id: 'phalanges', name: 'Formations en Phalange', cost: { research: 300 }, description: 'Tactiques de base (+20% d√©fense)' }, { id: 'legions', name: 'L√©gions', cost: { research: 500 }, description: 'Unit√©s d\'√©lite d√©bloqu√©es' } ] },
            economie: { name: '√âconomie', icon: 'üí∞', techs: [ { id: 'routes', name: 'Routes Commerciales', cost: { research: 200 }, description: 'Commerce plus efficace (+25% revenus)' }, { id: 'banques', name: 'Syst√®mes Bancaires', cost: { research: 450 }, description: 'Gestion financi√®re avanc√©e' } ] },
            diplomatie: { name: 'Diplomatie', icon: 'ü§ù', techs: [ { id: 'ambassades', name: 'Ambassades', cost: { research: 350 }, description: 'Relations diplomatiques stables' }, { id: 'espionnage', name: 'R√©seaux d\'Espionnage', cost: { research: 550 }, description: 'Information sur les ennemis' } ] }
        };

        // Configuration des unit√©s terrestres
        const UNITS_CONFIG = {
            velites: { name: 'V√©lites', icon: 'üèÉ', attack: 5, defense: 2, cost: { iron: 10, gold: 5 } },
            hastati: { name: 'Hastati', icon: 'üõ°Ô∏è', attack: 10, defense: 6, cost: { iron: 20, gold: 10 } },
            legionnaires: { name: 'L√©gionnaires', icon: '‚öîÔ∏è', attack: 25, defense: 15, cost: { iron: 50, gold: 20 } },
            equites: { name: 'Equites', icon: 'üêé', attack: 20, defense: 8, cost: { iron: 40, gold: 15 } },
            balistes: { name: 'Balistes', icon: 'üèπ', attack: 50, defense: 5, cost: { wood: 100, gold: 50 } }
        };
        
        // --- NOUVELLE CONFIGURATION POUR LE MONDE ---
        const WORLD_CONFIG = {
            factions: {
                roman: { name: 'Empire Romain', color: '#dc2626', description: 'Votre glorieux empire, destin√© √† dominer le monde connu.' },
                barbarian: { name: 'Royaumes Barbares', color: '#a16207', description: 'Tribus indisciplin√©es et villages ind√©pendants qui peuplent les terres sauvages.' },
                parthian: { name: 'Empire Parthe', color: '#7c3aed', description: 'Un empire rival √† l\'est, c√©l√®bre pour ses cavaliers archers.' }
            },
            cities: [
                { id: 'roma', name: 'Rome', faction: 'roman', type: 'capital', coords: [41.9, 12.5], population: 1000000, strength: 50000 },
                { id: 'lutetia', name: 'Lut√®ce', faction: 'barbarian', type: 'city', coords: [48.85, 2.35], population: 5000, strength: 2000 },
                { id: 'byzantium', name: 'Byzance', faction: 'roman', type: 'city', coords: [41.01, 28.97], population: 80000, strength: 15000 },
                { id: 'carthage', name: 'Carthage', faction: 'roman', type: 'city', coords: [36.85, 10.32], population: 150000, strength: 25000 },
                { id: 'barb_camp_1', name: 'Camp des Goths', faction: 'barbarian', type: 'barbarian_camp', coords: [46.5, 25.0], population: 1200, strength: 3500 },
                { id: 'barb_camp_2', name: 'Village des Germains', faction: 'barbarian', type: 'barbarian_camp', coords: [51.0, 10.0], population: 2000, strength: 4200 },
                { id: 'ctesiphon', name: 'Ct√©siphon', faction: 'parthian', type: 'capital', coords: [33.09, 44.58], population: 500000, strength: 40000 },
            ]
        };
        // --- FIN DE LA CONFIGURATION DU MONDE ---

        let worldMap; // Variable globale pour la carte Leaflet

        // Fonctions utilitaires
        function safeGetElement(id) {
            const element = document.getElementById(id);
            if (!element) console.warn(`Element with id '${id}' not found`);
            return element;
        }

        function safeUpdateElement(id, content, isHTML = false) {
            const element = safeGetElement(id);
            if (element) {
                if (isHTML) element.innerHTML = content;
                else element.textContent = content;
            }
        }
        
        // Initialisation du jeu
        function initGame() {
            createParticles();
            initNavigation();
            loadGame();
            startGameLoops();
            switchView('city');
            logEvent(`üèõÔ∏è Bienvenue dans IMPERIUM, ${gameState.player.name} !`);
            updatePlayerInfo();
            updateAllUI();
        }
        
        // Boucle de jeu principale
        function startGameLoops() {
            setInterval(() => {
                const now = Date.now();
                const delta = (now - gameState.lastUpdate) / 1000; // secondes √©coul√©es
                
                // 1. Mettre √† jour le bonheur
                gameState.provinces[0].happiness = calculateHappiness();

                // 2. G√©rer la croissance de la population
                const popMax = calculatePopulationMax();
                const currentPop = gameState.provinces[0].population;
                if (currentPop < popMax) {
                    const growthRate = (gameState.provinces[0].happiness / 5000) * (delta / 60);
                    gameState.provinces[0].population = Math.min(currentPop + growthRate, popMax);
                }
                
                // 3. Calculer la production pour le delta de temps
                const production = calculateHourlyProduction();
                const capacity = calculateStorageCapacity();
                
                Object.keys(gameState.resources).forEach(res => {
                    if (production[res]) {
                        const producedAmount = production[res] * (delta / 3600);
                        const currentAmount = gameState.resources[res];
                        const maxAmount = capacity[res] || Infinity;
                        
                        gameState.resources[res] = Math.min(currentAmount + producedAmount, maxAmount);
                    }
                });
                
                gameState.lastUpdate = now;
                updateAllUI();
            }, GAME_CONFIG.updateInterval);
        }

        // Calculs bas√©s sur les formules
        function calculatePopulationMax() {
            const forumLevel = gameState.buildings.forum?.level || 0;
            return 50 + (25 * forumLevel);
        }
        
        function calculateHappiness() {
            let happiness = 50; // Base
            
            if (gameState.buildings.tavern) {
                happiness += BUILDINGS_CONFIG.tavern.happiness * gameState.buildings.tavern.level;
            }
            
            const popMax = calculatePopulationMax();
            const currentPop = gameState.provinces[0].population;
            const populationRatio = currentPop / popMax;
            if (populationRatio > 0.9) {
                happiness -= (populationRatio - 0.9) * 100;
            }
            
            return Math.max(0, Math.min(100, Math.round(happiness)));
        }

        function calculateHourlyProduction() {
            const production = { wood: 0, stone: 0, wine: 0, iron: 0, gold: 0, research: 0 };
            const allianceBonus = gameState.player.alliance.bonus || 0;
            const islandBonus = gameState.provinces[0].islandBonus || {};
            
            const happiness = gameState.provinces[0].happiness;
            const productivityModifier = happiness < 50 ? 1 - ((50 - happiness) * 0.015) : 1;
            
            for (const [buildingType, buildingData] of Object.entries(gameState.buildings)) {
                const config = BUILDINGS_CONFIG[buildingType];
                if (config && config.production) {
                    const { type, base } = config.production;
                    const level = buildingData.level;
                    const hourlyProd = base * (1 + 0.1 * (level - 1)) * (1 + (islandBonus[type] || 0)) * (1 + allianceBonus) * productivityModifier;
                    production[type] += hourlyProd;
                }
            }
            production.research += (gameState.buildings.academy?.level || 0) * 10;
            return production;
        }

        function calculateStorageCapacity() {
            const warehouseLevel = gameState.buildings.warehouse?.level || 0;
            if (warehouseLevel === 0) return { wood: 1000, stone: 1000, wine: 1000, iron: 1000, gold: Infinity, research: Infinity };
            const capacity = Math.floor(500 * Math.pow(warehouseLevel, 1.2));
            return { wood: capacity, stone: capacity, wine: capacity, iron: capacity, gold: Infinity, research: Infinity };
        }

        // Initialisation de la navigation
        function initNavigation() {
            document.querySelectorAll('.nav-item a, .mobile-nav-item').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const viewId = link.dataset.view;
                    if (viewId) switchView(viewId);
                });
            });
            safeGetElement('save-btn').addEventListener('click', saveGame);
            safeGetElement('load-btn').addEventListener('click', loadGame);
        }

        // Gestion de la navigation entre vues
        function switchView(viewId) {
            document.querySelectorAll('.view-container').forEach(view => view.classList.remove('active'));
            const targetView = safeGetElement(`view-${viewId}`);
            if (targetView) targetView.classList.add('active');
            
            document.querySelectorAll('.nav-item a, .mobile-nav-item').forEach(link => link.classList.remove('active'));
            document.querySelectorAll(`[data-view="${viewId}"]`).forEach(link => link.classList.add('active'));
            
            gameState.currentView = viewId;
            
            // Appeler la fonction de rendu sp√©cifique √† la vue
            switch(viewId) {
                case 'city': renderCityView(); break;
                case 'research': renderResearchView(); break;
                case 'military': renderMilitaryView(); break;
                case 'world': renderWorldView(); break;
            }
            logEvent(`Navigation vers ${getViewTitle(viewId)}`);
        }

        function getViewTitle(viewId) {
            const link = document.querySelector(`.nav-item a[data-view="${viewId}"]`);
            return link ? link.textContent.trim() : viewId;
        }

        // Rendu de la vue Cit√©
        function renderCityView() {
            const grid = safeGetElement('buildings-grid');
            if (!grid) return;
            grid.innerHTML = '';
            
            for (let y = 0; y < 4; y++) {
                for (let x = 0; x < 5; x++) {
                    const plot = document.createElement('div');
                    plot.className = 'building-plot';
                    plot.dataset.x = x; plot.dataset.y = y;
                    const building = findBuildingAt(x, y);
                    if (building) {
                        plot.classList.add('built');
                        const config = BUILDINGS_CONFIG[building.type];
                        plot.innerHTML = `<div class="building-icon">${config.icon}</div><div class="building-name">${config.name}</div><div class="building-level">Niv. ${building.level}</div>`;
                        plot.onclick = () => manageBuilding(building.type);
                    } else {
                        plot.innerHTML = `<div class="building-icon" style="opacity: 0.5;">‚ûï</div><div class="building-name" style="color: var(--text-muted);">Construire</div>`;
                        plot.onclick = () => showBuildingOptions(x, y);
                    }
                    grid.appendChild(plot);
                }
            }
            updateCityPanel();
        }
        
        function findBuildingAt(x, y) {
            return Object.entries(gameState.buildings).map(([type, b]) => ({type, ...b})).find(b => b.x === x && b.y === y);
        }

        // Fonctions de gestion des b√¢timents
        function showBuildingOptions(x, y) {
            const builtTypes = Object.keys(gameState.buildings);
            const availableBuildings = Object.keys(BUILDINGS_CONFIG).filter(type => !builtTypes.includes(type));
            let html = `<div style="display: grid; grid-template-columns: 1fr; gap: 1rem; margin-top: 1rem; max-height: 400px; overflow-y: auto;">`;
            availableBuildings.forEach(type => {
                const config = BUILDINGS_CONFIG[type];
                const cost = calculateBuildingCost(type, 1);
                const canAfford = canAffordCost(cost);
                html += `<div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: rgba(30,41,59,0.6); border-radius: 0.5rem; border: 1px solid ${canAfford ? 'var(--border-gold)' : '#6b7280'}; ${canAfford ? 'cursor: pointer;' : 'opacity: 0.5;'}" ${canAfford ? `onclick="buildBuilding('${type}', ${x}, ${y})"` : ''}>
                    <span style="font-size: 1.5rem;">${config.icon}</span>
                    <div style="flex-grow: 1;">
                        <div style="font-weight: bold; color: var(--gold-light);">${config.name}</div>
                        <div style="font-size: 0.8rem; color: var(--text-muted);">${config.description}</div>
                        <div style="font-size: 0.8rem; color: var(--gold-primary);">Co√ªt: ${formatCost(cost)}</div>
                    </div></div>`;
            });
            html += '</div>';
            showModal('Choisir un b√¢timent', html);
        }
        
        function calculateBuildingCost(type, level) {
            const baseCosts = { forum: { wood: 500, stone: 200, gold: 300 }, warehouse: { wood: 200, stone: 100 }, barracks: { wood: 300, iron: 150, gold: 200 }, academy: { wood: 400, stone: 200, gold: 250 }, lumbercamp: { wood: 150, stone: 50 }, quarry: { wood: 100, stone: 150 }, vineyard: { wood: 200, gold: 100 }, ironmine: { wood: 150, stone: 100 }, mint: { wood: 300, stone: 150, gold: 100 }, tavern: { wood: 200, wine: 50 }, temple: { wood: 400, stone: 300, gold: 500 }, library: { wood: 300, stone: 200, gold: 200 }, shipyard: { wood: 600, iron: 200 }, wall: { wood: 400, stone: 500 }, amphitheater: { wood: 800, stone: 600, gold: 1000 } };
            const baseCost = baseCosts[type] || {};
            const multiplier = Math.pow(1.5, level - 1);
            const result = {};
            Object.entries(baseCost).forEach(([resource, amount]) => { result[resource] = Math.ceil(amount * multiplier); });
            return result;
        }

        function formatCost(cost) {
            const resourceIcons = { wood: 'üå≤', stone: 'ü™®', wine: 'üçá', iron: '‚õèÔ∏è', gold: 'üí∞', research: 'üìö' };
            return Object.entries(cost).map(([res, amount]) => `${resourceIcons[res] || res} ${amount.toLocaleString()}`).join(' ');
        }

        function canAffordCost(cost) {
            return Object.entries(cost).every(([res, amount]) => gameState.resources[res] >= amount);
        }

        function buildBuilding(type, x, y) {
            const cost = calculateBuildingCost(type, 1);
            if (!canAffordCost(cost)) {
                showNotification('Ressources insuffisantes', 'error'); return;
            }
            Object.entries(cost).forEach(([res, amount]) => { gameState.resources[res] -= amount; });
            gameState.buildings[type] = { level: 1, x: x, y: y };
            const config = BUILDINGS_CONFIG[type];
            logEvent(`üèóÔ∏è Construction de ${config.name} commenc√©e`);
            closeModal();
            renderCityView();
            updateAllUI();
            setTimeout(() => {
                const plot = document.querySelector(`[data-x="${x}"][data-y="${y}"]`);
                if (plot) plot.classList.add('building-completed');
                showNotification(`${config.name} construit !`, 'success');
            }, 1000);
        }

        function manageBuilding(type) {
            const building = gameState.buildings[type];
            const config = BUILDINGS_CONFIG[type];
            if (!building || !config) return;
            const nextLevel = building.level + 1;
            const upgradeCost = calculateBuildingCost(type, nextLevel);
            const canUpgrade = canAffordCost(upgradeCost);
            let html = `<p style="margin-bottom: 1rem;">Niveau actuel: <strong>${building.level}</strong></p><p style="margin: 1rem 0;">${config.description}</p>`;
            if (building.level < 20) {
                html += `<div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-gold);"><h4 style="color: var(--gold-primary);">Am√©lioration niveau ${nextLevel}</h4><p>Co√ªt: ${formatCost(upgradeCost)}</p><button class="action-btn" ${canUpgrade ? `onclick="upgradeBuilding('${type}')"` : 'disabled'}>${canUpgrade ? 'Am√©liorer' : 'Ressources insuffisantes'}</button></div>`;
            } else {
                html += '<p style="color: var(--gold-light); margin-top: 1rem;">Niveau maximum atteint</p>';
            }
            showModal(`${config.icon} ${config.name}`, html);
        }

        function upgradeBuilding(type) {
            const building = gameState.buildings[type];
            if(!building) return;
            const cost = calculateBuildingCost(type, building.level + 1);
            if (!canAffordCost(cost)) { showNotification('Ressources insuffisantes', 'error'); return; }
            Object.entries(cost).forEach(([res, amount]) => { gameState.resources[res] -= amount; });
            building.level++;
            const config = BUILDINGS_CONFIG[type];
            logEvent(`‚¨ÜÔ∏è ${config.name} am√©lior√© au niveau ${building.level}`);
            closeModal();
            renderCityView();
            updateAllUI();
            showNotification(`${config.name} am√©lior√© !`, 'success');
        }

        // Rendu de la vue Recherche
        function renderResearchView() {
            const layout = safeGetElement('research-layout');
            if(!layout) return;
            layout.innerHTML = '';
            Object.entries(TECH_TREE).forEach(([branchKey, branchData]) => {
                const branchEl = document.createElement('div');
                branchEl.className = 'research-branch';
                let html = `<h3 class="branch-title">${branchData.icon} ${branchData.name}</h3>`;
                branchData.techs.forEach(tech => {
                    const isResearched = gameState.technologies.includes(tech.id);
                    const canAfford = canAffordCost(tech.cost);
                    const canResearch = !isResearched && canAfford;
                    html += `<div class="tech-card ${isResearched ? 'researched' : ''}" ${canResearch ? `onclick="researchTech('${tech.id}')"` : ''} style="${!isResearched && !canAfford ? 'opacity:0.6; cursor: not-allowed;' : ''}">
                        <div class="tech-name">${tech.name} ${isResearched ? '‚úÖ' : ''}</div>
                        <div class="tech-description">${tech.description}</div>
                        <div class="tech-cost"><span class="cost-display">${isResearched ? 'Recherch√©' : `Co√ªt: ${formatCost(tech.cost)}`}</span>
                        ${canResearch ? `<button class="action-btn" style="width: auto; padding: 0.5rem 1rem;">Rechercher</button>` : ''}</div></div>`;
                });
                branchEl.innerHTML = html;
                layout.appendChild(branchEl);
            });
        }

        function researchTech(techId) {
            const tech = Object.values(TECH_TREE).flatMap(b => b.techs).find(t => t.id === techId);
            if (!tech || gameState.technologies.includes(techId) || !canAffordCost(tech.cost)) {
                showNotification('Impossible de lancer cette recherche.', 'error'); return;
            }
            Object.entries(tech.cost).forEach(([res, amount]) => gameState.resources[res] -= amount);
            gameState.technologies.push(techId);
            showNotification(`Technologie "${tech.name}" acquise !`, 'success');
            updateAllUI();
            renderResearchView();
        }
        
        // Rendu de la vue Militaire
        function renderMilitaryView() {
            const wrapper = safeGetElement('military-content-wrapper');
            if (!gameState.buildings.barracks) {
                wrapper.innerHTML = `<p style="text-align:center;">Vous devez construire une Caserne pour recruter des troupes.</p>`;
                return;
            }
            wrapper.innerHTML = `<div class="military-layout">
                <div id="military-owned" class="military-section">
                    <h3 class="section-title">Mes Troupes</h3>
                    <div id="owned-units-grid" class="unit-grid"></div>
                </div>
                <div id="military-recruit" class="military-section">
                    <h3 class="section-title">Recruter des Unit√©s</h3>
                    <div id="recruit-units-grid" class="unit-grid"></div>
                </div>
            </div>`;
            
            const ownedGrid = safeGetElement('owned-units-grid');
            const recruitGrid = safeGetElement('recruit-units-grid');
            
            ownedGrid.innerHTML = '';
            const ownedUnits = Object.entries(gameState.units).filter(([_, count]) => count > 0);
            if (ownedUnits.length > 0) {
                ownedUnits.forEach(([type, count]) => {
                    const config = UNITS_CONFIG[type];
                    ownedGrid.innerHTML += `<div class="unit-card"><div class="unit-icon">${config.icon}</div><div><div class="unit-name">${config.name}</div><div class="unit-count">${count.toLocaleString()}</div></div></div>`;
                });
            } else {
                ownedGrid.innerHTML = '<p>Aucune troupe dans la cit√©.</p>';
            }

            recruitGrid.innerHTML = '';
            Object.entries(UNITS_CONFIG).forEach(([type, config]) => {
                recruitGrid.innerHTML += `<div class="unit-card" onclick="showRecruitModal('${type}')">
                    <div class="unit-icon">${config.icon}</div>
                    <div><div class="unit-name">${config.name}</div>
                    <div class="unit-stats">A:${config.attack} / D:${config.defense}</div>
                    <div class="unit-cost" style="font-size:0.8rem">${formatCost(config.cost)}</div></div></div>`;
            });
        }

        function showRecruitModal(type) {
            const config = UNITS_CONFIG[type];
            if (!config) return;
            const maxRecruitable = Math.min(...Object.entries(config.cost).map(([res, cost]) => Math.floor(gameState.resources[res] / cost)));
            let bodyHtml = `<p>${config.description || ''}</p>
                <div style="margin: 1rem 0;"><label for="recruit-amount">Quantit√© (Max: ${maxRecruitable.toLocaleString()})</label>
                <input type="range" id="recruit-slider" class="recruit-slider" min="0" max="${maxRecruitable}" value="0" oninput="updateRecruitCost('${type}')">
                <p id="recruit-amount-label" style="text-align:center; font-weight:bold; font-size: 1.2rem;">0</p></div>
                <div id="recruit-cost-details" class="recruit-details">Co√ªt total: 0</div>`;
            let actionsHtml = `<button class="modal-btn cancel" onclick="closeModal()">Annuler</button>
                <button id="recruit-confirm-btn" class="modal-btn confirm" onclick="recruitUnits('${type}')" disabled>Recruter</button>`;
            showModal(`Recruter des ${config.name}`, bodyHtml, actionsHtml);
        }
        
        function updateRecruitCost(type) {
            const config = UNITS_CONFIG[type];
            const slider = safeGetElement('recruit-slider');
            const amount = parseInt(slider.value);
            safeUpdateElement('recruit-amount-label', amount.toLocaleString());
            const totalCost = {};
            Object.entries(config.cost).forEach(([res, unitCost]) => { totalCost[res] = unitCost * amount; });
            const costDetailsEl = safeGetElement('recruit-cost-details');
            costDetailsEl.innerHTML = `Co√ªt total: ${formatCost(totalCost)}`;
            const canAfford = canAffordCost(totalCost);
            safeGetElement('recruit-confirm-btn').disabled = !canAfford || amount === 0;
            costDetailsEl.style.color = canAfford ? 'var(--text-light)' : 'var(--storage-full-red)';
        }

        function recruitUnits(type) {
            const config = UNITS_CONFIG[type];
            const amount = parseInt(safeGetElement('recruit-slider').value);
            if (amount <= 0) return;
            const totalCost = {};
            Object.entries(config.cost).forEach(([res, unitCost]) => { totalCost[res] = unitCost * amount; });
            if (!canAffordCost(totalCost)) {
                showNotification("Ressources insuffisantes.", 'error'); return;
            }
            Object.entries(totalCost).forEach(([res, cost]) => { gameState.resources[res] -= cost; });
            if (!gameState.units[type]) gameState.units[type] = 0;
            gameState.units[type] += amount;
            showNotification(`${amount.toLocaleString()} ${config.name} recrut√©(s) !`, 'success');
            closeModal();
            updateAllUI();
            renderMilitaryView();
        }

        // --- NOUVELLES FONCTIONS POUR LA VUE MONDE ---
        function renderWorldView() {
            const viewContainer = safeGetElement('view-world');
            if (!viewContainer) return;

            // Initialiser la structure HTML de la vue Monde si elle n'existe pas
            if (!viewContainer.querySelector('#world-map')) {
                viewContainer.innerHTML = `
                    <div class="world-layout">
                        <div id="world-map-container">
                            <div id="world-map"></div>
                        </div>
                        <aside id="world-info-panel">
                            <!-- Le contenu sera inject√© ici -->
                        </aside>
                    </div>
                `;
                initWorldMap();
                updateWorldInfoPanel(); // Afficher le panneau par d√©faut
            }
            
            // S'assurer que la carte se redimensionne correctement
            if (worldMap) {
                setTimeout(() => worldMap.invalidateSize(), 100);
            }
        }
        
        function initWorldMap() {
            if (worldMap) return; // Ne pas r√©initialiser si la carte existe d√©j√†

            worldMap = L.map('world-map', {
                center: [45, 15],
                zoom: 4,
                minZoom: 3,
                maxZoom: 7,
                maxBounds: [[-20, -40], [80, 80]], // Limiter le d√©filement
                attributionControl: false
            });

            // Ajout d'une couche de tuiles sombres qui correspond au th√®me
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                subdomains: 'abcd'
            }).addTo(worldMap);

            // Cr√©ation des ic√¥nes personnalis√©es
            const icons = {
                capital: L.divIcon({
                    className: 'map-marker-icon',
                    html: 'üèõÔ∏è',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                }),
                city: L.divIcon({
                    className: 'map-marker-icon',
                    html: '‚óè',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                }),
                barbarian_camp: L.divIcon({
                    className: 'map-marker-icon',
                    html: 'üèïÔ∏è',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                })
            };

            // Ajout des marqueurs de ville
            WORLD_CONFIG.cities.forEach(city => {
                const marker = L.marker(city.coords, { icon: icons[city.type] || icons.city })
                    .addTo(worldMap)
                    .on('click', () => {
                        updateWorldInfoPanel(city);
                    });
                
                // Info-bulle au survol
                marker.bindTooltip(`<b>${city.name}</b><br>${WORLD_CONFIG.factions[city.faction].name}`, {
                    direction: 'top',
                    offset: [0, -10],
                    className: 'map-tooltip'
                });
            });
        }

        function updateWorldInfoPanel(city = null) {
            const panel = safeGetElement('world-info-panel');
            if (!panel) return;
            
            let html = '';
            if (city) {
                const faction = WORLD_CONFIG.factions[city.faction];
                html = `
                    <h3 class="info-panel-title" style="color: ${faction.color};">${city.name}</h3>
                    <div class="info-panel-section">
                        <h4>Faction</h4>
                        <p><strong>${faction.name}</strong></p>
                    </div>
                    <div class="info-panel-section">
                        <h4>D√©tails</h4>
                        <p>Population: <strong>${city.population.toLocaleString()}</strong></p>
                        <p>Force Militaire: <strong>${city.strength.toLocaleString()}</strong></p>
                    </div>
                    <div class="info-panel-section">
                        <h4>Actions</h4>
                        <button class="action-btn" onclick="showNotification('Espionnage non impl√©ment√©', 'error')">Espionner</button>
                        <button class="action-btn" onclick="showNotification('Attaque non impl√©ment√©e', 'error')" ${city.faction === 'roman' ? 'disabled' : ''}>Attaquer</button>
                    </div>
                `;
            } else {
                html = `
                    <h3 class="info-panel-title">Le Monde Connu</h3>
                    <div class="info-panel-section">
                        <p>Explorez le monde, d√©couvrez de nouvelles cit√©s et √©tendez l'influence de Rome. Cliquez sur une ville pour afficher ses d√©tails et interagir avec elle.</p>
                    </div>
                `;
            }
            panel.innerHTML = html;
        }
        // --- FIN DES FONCTIONS DE LA VUE MONDE ---

        // Fonctions de mise √† jour de l'UI
        function updateAllUI() {
            updateResourceDisplay();
            if (gameState.currentView === 'city') {
                updateCityPanel();
            }
        }
        
        function updateCityPanel() {
            updateCityStats();
            updateStorageDisplay();
            updateProductionDisplay();
        }
        
        function updateResourceDisplay() {
            const container = safeGetElement('resources-display');
            if (!container) return;
            const resourceIcons = { wood: 'üå≤', stone: 'ü™®', wine: 'üçá', iron: '‚õèÔ∏è', gold: 'üí∞', research: 'üìö'};
            const capacity = calculateStorageCapacity();
            let html = '';
            Object.entries(resourceIcons).forEach(([res, icon]) => {
                const isFull = gameState.resources[res] >= (capacity[res] || Infinity);
                html += `<div class="resource-item"><span class="resource-icon">${icon}</span>
                    <span id="resource-${res}" class="resource-value ${isFull ? 'storage-full-indicator' : ''}">${Math.floor(gameState.resources[res]).toLocaleString()}</span></div>`;
            });
            container.innerHTML = html;
        }

        function updatePlayerInfo() {
            const { name, title, level } = gameState.player;
            safeUpdateElement('player-name', name);
            safeUpdateElement('player-title-level', `${title} - Niv. ${level}`);
            safeUpdateElement('player-avatar', name.charAt(0).toUpperCase());
        }

        function updateCityStats() {
            const container = safeGetElement('city-stats-content');
            if(!container) return;
            const happiness = gameState.provinces[0].happiness;
            const happinessColor = happiness < 30 ? 'var(--storage-full-red)' : happiness < 60 ? 'var(--gold-light)' : 'var(--success-green)';
            
            container.innerHTML = `<div class="quick-stats">
                <div class="stat-card">
                    <div class="stat-value">${Math.floor(gameState.provinces[0].population).toLocaleString()} / ${calculatePopulationMax().toLocaleString()}</div>
                    <div class="stat-label">Population</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" style="color: ${happinessColor};">${happiness}%</div>
                    <div class="stat-label">Bonheur</div>
                </div>
            </div>`;
        }
        
        function updateProductionDisplay() {
            const container = safeGetElement('production-content');
            if(!container) return;
            const prod = calculateHourlyProduction();
            let html = '';
            Object.entries(prod).forEach(([res, val]) => {
                if (val !== 0) html += `<p>${formatCost({[res]:''})} ${val > 0 ? '+' : ''}${val.toFixed(0).toLocaleString()}</p>`;
            });
            container.innerHTML = html || '<p>Aucune production.</p>';
        }
        
        function updateStorageDisplay() {
            const container = safeGetElement('storage-content');
            if(!container) return;
            const capacity = calculateStorageCapacity();
            container.innerHTML = `<p>Capacit√© de base : ${capacity.wood.toLocaleString()}</p>`;
        }

        // Fonctions de compl√©tion (placeholders)
        function logEvent(message) {
            const logEl = safeGetElement('event-log');
            if (logEl) {
                logEl.textContent = message;
                logEl.style.animation = 'none';
                logEl.offsetHeight; // Trigger reflow
                logEl.style.animation = 'fadeIn 0.5s ease';
            }
        }

        function showModal(title, bodyHtml, actionsHtml = null) {
            safeUpdateElement('modal-title', title);
            safeUpdateElement('modal-body', bodyHtml, true);
            const actionsContainer = safeGetElement('modal-actions');
            if (actionsHtml) {
                actionsContainer.innerHTML = actionsHtml;
            } else {
                actionsContainer.innerHTML = `<button class="modal-btn cancel" onclick="closeModal()">Fermer</button>`;
            }
            safeGetElement('modal-overlay').style.display = 'flex';
        }

        function closeModal() {
            safeGetElement('modal-overlay').style.display = 'none';
        }
        
        function showNotification(message, type = 'info') { // type: 'info', 'success', 'error'
            const container = safeGetElement('notification-container');
            if(!container) return;
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.textContent = message;
            container.appendChild(notif);
            setTimeout(() => { notif.remove(); }, 3000);
        }

        function createParticles() {
            const container = safeGetElement('particles');
            if (!container) return;
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 8 + 's';
                particle.style.animationDuration = (8 + Math.random() * 4) + 's';
                container.appendChild(particle);
            }
        }

        // Sauvegarde et chargement
        function saveGame() {
            try {
                localStorage.setItem('imperiumGameState_v3', JSON.stringify(gameState));
                showNotification('Partie sauvegard√©e !', 'success');
            } catch (e) {
                showNotification('Erreur de sauvegarde.', 'error');
            }
        }

        function loadGame() {
            try {
                const savedState = localStorage.getItem('imperiumGameState_v3');
                if (savedState) {
                    gameState = JSON.parse(savedState);
                    logEvent('‚úîÔ∏è Partie charg√©e avec succ√®s !');
                }
            } catch (e) {
                logEvent('‚ö†Ô∏è Impossible de charger la sauvegarde.');
            }
            gameState.lastUpdate = Date.now();
        }

        // D√©marrage du jeu lorsque le DOM est pr√™t
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
